<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CLS Linkage Graph</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden; /* Prevent scrollbars */
        }
        .node text {
            pointer-events: none;
            font-size: 10px;
            font-weight: bold;
            text-anchor: middle;
            fill: #1f2937; /* dark gray */
        }
        .link-label {
            font-size: 8px;
            fill: #4b5563; /* medium gray */
            text-anchor: middle;
            background-color: rgba(255, 255, 255, 0.7);
            padding: 1px;
        }
        /* Custom scrollbar for textarea */
        textarea::-webkit-scrollbar {
            width: 8px;
        }
        textarea::-webkit-scrollbar-track {
            background: #f1f5f9; /* slate-100 */
        }
        textarea::-webkit-scrollbar-thumb {
            background: #94a3b8; /* slate-400 */
            border-radius: 4px;
        }
        textarea::-webkit-scrollbar-thumb:hover {
            background: #64748b; /* slate-500 */
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col items-center justify-center h-screen m-0 p-4">
    <div class="w-full max-w-7xl bg-white rounded-lg shadow-2xl p-4 flex flex-col h-[95vh]">
        <h1 class="text-2xl font-bold text-center text-gray-800 mb-4 flex-shrink-0">CLS Linkage Graph</h1>
        <div class="flex-grow flex flex-col md:flex-row gap-4 min-h-0">
            <!-- Input Area -->
            <div class="w-full md:w-1/3 flex flex-col">
                <label for="json-input" class="text-sm font-medium text-gray-700 mb-2">JSON Data Input</label>
                <textarea id="json-input" class="flex-grow w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm font-mono bg-slate-50 resize-none"></textarea>
                <button id="render-btn" class="mt-2 w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors duration-200">
                    Render Graph
                </button>
                <div id="error-message" class="mt-2 text-red-600 text-xs font-medium h-4"></div>
            </div>
            <!-- Graph Area -->
            <div id="graph-container" class="flex-grow w-full md:w-2/3 h-full border border-gray-200 rounded-lg"></div>
        </div>
    </div>

    <script>
        const jsonInput = document.getElementById('json-input');
        const renderBtn = document.getElementById('render-btn');
        const errorMessage = document.getElementById('error-message');
        const graphContainer = document.getElementById('graph-container');

        // Initial JSON data to populate the textarea
        const initialData = {
            "paths": [
                {
                    "vertices": [
                        {"id": 5170, "properties_json": "", "tags": ["user"]},
                        {"id": 1357358523451104587, "properties_json": "{\"ctime\":3,\"original_security_device_id\":\"testdevice1\"}", "tags": ["security_device_id"]}
                    ],
                    "edges": [
                        {"edge_name": "user_security_device_id_linkage", "from_entity_id": 5170, "to_entity_id": 1357358523451104587}
                    ]
                },
                {
                    "vertices": [
                        {"id": 5170, "properties_json": "", "tags": ["user"]},
                        {"id": 6538220262834120506, "properties_json": "{\"ctime\":0,\"original_ip\":\"testip1\"}", "tags": ["ip"]}
                    ],
                    "edges": [
                        {"edge_name": "user_ip_linkage", "from_entity_id": 5170, "to_entity_id": 6538220262834120506}
                    ]
                },
                {
                    "vertices": [
                        {"id": 5170, "properties_json": "", "tags": ["user"]},
                        {"id": 8600792527692065988, "properties_json": "{\"ctime\":3,\"original_ip\":\"testip2\"}", "tags": ["ip"]}
                    ],
                    "edges": [
                        {"edge_name": "user_ip_linkage", "from_entity_id": 5170, "to_entity_id": 8600792527692065988}
                    ]
                }
            ]
        };

        // Function to render the graph
        function renderGraph(jsonString) {
            // 1. Clear previous graph and error messages
            errorMessage.textContent = '';
            d3.select("#graph-container").select("svg").remove();

            let data;
            // 2. Parse JSON input
            try {
                data = JSON.parse(jsonString);
                if (!data.paths || !Array.isArray(data.paths)) {
                    throw new Error("Input must be a JSON object with a 'paths' array.");
                }
            } catch (error) {
                errorMessage.textContent = `Error: ${error.message}`;
                return;
            }

            // --- 3. Data Processing ---
            const nodesMap = new Map();
            const links = [];

            data.paths.forEach(path => {
                if (!path.vertices || !path.edges) return;
                path.vertices.forEach(v => {
                    if (!nodesMap.has(v.id)) {
                        const tag = v.tags && v.tags.length > 0 ? v.tags[0] : "unknown";
                        let props = {};
                        try {
                            props = v.properties_json ? JSON.parse(v.properties_json) : {};
                        } catch (e) {
                            console.error("Failed to parse properties_json:", v.properties_json);
                        }
                        const label = `${tag}\n${props.original_ip || props.original_security_device_id || v.id}`;
                        nodesMap.set(v.id, { id: v.id, label: label, tag: tag });
                    }
                });
                path.edges.forEach(edge => {
                    links.push({
                        source: edge.from_entity_id,
                        target: edge.to_entity_id,
                        label: edge.edge_name
                    });
                });
            });

            const nodes = Array.from(nodesMap.values());
            if (nodes.length === 0) {
                errorMessage.textContent = "No nodes found in the provided data.";
                return;
            }

            // --- 4. D3 Visualization ---
            const width = graphContainer.clientWidth;
            const height = graphContainer.clientHeight;

            const svg = d3.select("#graph-container").append("svg")
                .attr("width", width)
                .attr("height", height)
                .attr("viewBox", [-width / 2, -height / 2, width, height]);

            const color = d3.scaleOrdinal(d3.schemeCategory10)
                .domain(["user", "ip", "security_device_id"]);

            const simulation = d3.forceSimulation(nodes)
                .force("link", d3.forceLink(links).id(d => d.id).distance(200).strength(0.5))
                .force("charge", d3.forceManyBody().strength(-500))
                .force("center", d3.forceCenter(0, 0))
                .force("x", d3.forceX().strength(0.05))
                .force("y", d3.forceY().strength(0.05));

            const link = svg.append("g")
                .attr("stroke", "#999")
                .attr("stroke-opacity", 0.6)
                .selectAll("line")
                .data(links)
                .join("line")
                .attr("stroke-width", 2);

            const linkLabels = svg.append("g")
                .selectAll(".link-label")
                .data(links)
                .join("text")
                .attr("class", "link-label")
                .text(d => d.label);

            const node = svg.append("g")
                .selectAll("g")
                .data(nodes)
                .join("g")
                .attr("class", "node")
                .call(drag(simulation));

            node.append("circle")
                .attr("r", 35)
                .attr("fill", d => color(d.tag))
                .attr("stroke", d => d3.color(color(d.tag)).darker(1))
                .attr("stroke-width", 2);

            node.append("text")
                .selectAll("tspan")
                .data(d => d.label.split('\n'))
                .join("tspan")
                .attr("x", 0)
                .attr("dy", (d, i, arr) => `${i - arr.length / 2 + 0.8}em`)
                .text(d => d);

            simulation.on("tick", () => {
                link
                    .attr("x1", d => d.source.x)
                    .attr("y1", d => d.source.y)
                    .attr("x2", d => d.target.x)
                    .attr("y2", d => d.target.y);
                node
                    .attr("transform", d => `translate(${d.x},${d.y})`);
                linkLabels
                    .attr("x", d => (d.source.x + d.target.x) / 2)
                    .attr("y", d => (d.source.y + d.target.y) / 2);
            });

            function drag(simulation) {
                function dragstarted(event, d) {
                    if (!event.active) simulation.alphaTarget(0.3).restart();
                    d.fx = d.x;
                    d.fy = d.y;
                }
                function dragged(event, d) {
                    d.fx = event.x;
                    d.fy = event.y;
                }
                function dragended(event, d) {
                    if (!event.active) simulation.alphaTarget(0);
                    d.fx = null;
                    d.fy = null;
                }
                return d3.drag().on("start", dragstarted).on("drag", dragged).on("end", dragended);
            }
        }

        // --- Event Listeners ---
        renderBtn.addEventListener('click', () => {
            renderGraph(jsonInput.value);
        });

        // Handle window resizing
        let resizeTimer;
        window.onresize = () => {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(() => {
                if (jsonInput.value) renderGraph(jsonInput.value);
            }, 250); // Debounce resize event
        };

        // --- Initial Load ---
        // Populate textarea with initial data and render the first graph
        jsonInput.value = JSON.stringify(initialData, null, 2);
        renderGraph(jsonInput.value);

    </script>
</body>
</html>
